#include <gtest/gtest.h>

#include <Matrix/LQR.hpp>
#include <Util/AlmostEqual.hpp>

TEST(LQR, LQR) {
    Matrix<9, 9> A          = {{
        {0, 0, 0, 0.5, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0.5, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0.5, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 2.76914, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 2.61439, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, -1.67014},
        {0, 0, 0, 0, 0, 0, -28.5714, -0, -0},
        {0, 0, 0, 0, 0, 0, -0, -28.5714, -0},
        {0, 0, 0, 0, 0, 0, -0, -0, -28.5714},
    }};
    Matrix<9, 3> B          = {{
        {0, 0, 0},
        {0, 0, 0},
        {0, 0, 0},
        {0, 0, 0},
        {0, 0, 0},
        {0, 0, 211.441},
        {3330, 0, 0},
        {0, 3330, 0},
        {0, 0, 3330},
    }};
    Matrix<9, 9> Q          = {{
        {3, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 3, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 3, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0.000671492, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0.000671492, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0.000671492},
    }};
    Matrix<3, 3> R          = {{
        {9.12149, 0, 0},
        {0, 9.12149, 0},
        {0, 0, 9.12149},
    }};
    Matrix<3, 9> K          = -lqr(A, B, Q, R).K;
    Matrix<3, 9> K_expected = {{
        {
            -0.573493,
            -0.000000,
            -0.000000,
            -0.056737,
            -0.000000,
            -0.000000,
            -0.006963,
            -0.000000,
            -0.000000,
        },
        {
            -0.000000,
            -0.573493,
            -0.000000,
            -0.000000,
            -0.058212,
            -0.000000,
            -0.000000,
            -0.006868,
            -0.000000,
        },
        {
            -0.000000,
            -0.000000,
            -0.573493,
            -0.000000,
            -0.000000,
            -0.134089,
            -0.000000,
            -0.000000,
            0.004065,
        },
    }};
    bool passed             = isAlmostEqual(K, K_expected, 1e-6);
    ASSERT_TRUE(passed);
}